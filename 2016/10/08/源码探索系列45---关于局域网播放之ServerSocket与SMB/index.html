<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="SanjayF's  github  blog" />



  <meta name="keywords" content="android,socket," />





  <link rel="shorticon icon" type="image/x-icon" href="/fav.ico?v=0.4.5.1" />


<meta name="description" content="æœ€è¿‘éœ€è¦åšä¸€ä¸ªå±€åŸŸç½‘è§†é¢‘æ’­æ”¾çš„åŠŸèƒ½ï¼Œç”¨åˆ°ä¸¤ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œç„¶åé‡åˆ°äº†ä¼ é€å¤±è´¥ï¼Œé€Ÿåº¦ä¸º0 çš„é—®é¢˜ï¼Œåªå¥½çœ‹ä¸‹æ•´ä¸ªåº“çš„æºç ï¼Œæ”¹ä¸‹bugï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ•´ä¸ªé€»è¾‘çš„æµç¨‹ç¬”è®°ã€‚ æ•´ä¸ªå±€åŸŸç½‘æ’­æ”¾æµç•…ä¸»è¦æ˜¯ä¸‹é¢çš„æµç¨‹ å®¢æˆ·ç«¯ &amp;lt;--- (socketé€šè®¯)---&amp;gt;æœåŠ¡å™¨&amp;lt;---(smbåè®®)---&amp;gt;æŸå°å±€åŸŸç½‘ç”µè„‘ æˆ‘ä»¬çš„å®‰å“æ‰‹æœºå¦‚æœè¦æ’­æ”¾å±€åŸŸç½‘æŸå°ç”µè„‘ä¸Šçš„è§†é¢‘ï¼Œæˆ‘ä»¬éœ€è¦èµ·ä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œç”±è¿™">
<meta name="keywords" content="android,socket">
<meta property="og:type" content="article">
<meta property="og:title" content="æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¸ServerSocket">
<meta property="og:url" content="http://yoursite.com/2016/10/08/æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¹‹ServerSocketä¸SMB/index.html">
<meta property="og:site_name" content="SanjayF&#39;s blog">
<meta property="og:description" content="æœ€è¿‘éœ€è¦åšä¸€ä¸ªå±€åŸŸç½‘è§†é¢‘æ’­æ”¾çš„åŠŸèƒ½ï¼Œç”¨åˆ°ä¸¤ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œç„¶åé‡åˆ°äº†ä¼ é€å¤±è´¥ï¼Œé€Ÿåº¦ä¸º0 çš„é—®é¢˜ï¼Œåªå¥½çœ‹ä¸‹æ•´ä¸ªåº“çš„æºç ï¼Œæ”¹ä¸‹bugï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ•´ä¸ªé€»è¾‘çš„æµç¨‹ç¬”è®°ã€‚ æ•´ä¸ªå±€åŸŸç½‘æ’­æ”¾æµç•…ä¸»è¦æ˜¯ä¸‹é¢çš„æµç¨‹ å®¢æˆ·ç«¯ &amp;lt;--- (socketé€šè®¯)---&amp;gt;æœåŠ¡å™¨&amp;lt;---(smbåè®®)---&amp;gt;æŸå°å±€åŸŸç½‘ç”µè„‘ æˆ‘ä»¬çš„å®‰å“æ‰‹æœºå¦‚æœè¦æ’­æ”¾å±€åŸŸç½‘æŸå°ç”µè„‘ä¸Šçš„è§†é¢‘ï¼Œæˆ‘ä»¬éœ€è¦èµ·ä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œç”±è¿™">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-09-13T03:59:42.731Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¸ServerSocket">
<meta name="twitter:description" content="æœ€è¿‘éœ€è¦åšä¸€ä¸ªå±€åŸŸç½‘è§†é¢‘æ’­æ”¾çš„åŠŸèƒ½ï¼Œç”¨åˆ°ä¸¤ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œç„¶åé‡åˆ°äº†ä¼ é€å¤±è´¥ï¼Œé€Ÿåº¦ä¸º0 çš„é—®é¢˜ï¼Œåªå¥½çœ‹ä¸‹æ•´ä¸ªåº“çš„æºç ï¼Œæ”¹ä¸‹bugï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ•´ä¸ªé€»è¾‘çš„æµç¨‹ç¬”è®°ã€‚ æ•´ä¸ªå±€åŸŸç½‘æ’­æ”¾æµç•…ä¸»è¦æ˜¯ä¸‹é¢çš„æµç¨‹ å®¢æˆ·ç«¯ &amp;lt;--- (socketé€šè®¯)---&amp;gt;æœåŠ¡å™¨&amp;lt;---(smbåè®®)---&amp;gt;æŸå°å±€åŸŸç½‘ç”µè„‘ æˆ‘ä»¬çš„å®‰å“æ‰‹æœºå¦‚æœè¦æ’­æ”¾å±€åŸŸç½‘æŸå°ç”µè„‘ä¸Šçš„è§†é¢‘ï¼Œæˆ‘ä»¬éœ€è¦èµ·ä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œç”±è¿™">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¸ServerSocket | SanjayF's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?18f6d52faaf2600c05e8045494b5935e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>

      <span class="site-title">SanjayF's blog</span>
        <h6 id="subtitle-wrap">
           <span class="site-nav">ç”Ÿå‘½ä¸æ¯ï¼Œè£…é€¼ä¸æ­¢</span>    
        </h6>
       
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            Tags
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'qy4B6rmn6sA3Kyx-8Ysw','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¸ServerSocket
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2016-10-08T15:25:00+08:00" content="2016-10-08">
            2016-10-08
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/android/" itemprop="url" rel="index">
                  <span itemprop="name">android</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2016/10/08/æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¹‹ServerSocketä¸SMB/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/08/æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¹‹ServerSocketä¸SMB/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>æœ€è¿‘éœ€è¦åšä¸€ä¸ªå±€åŸŸç½‘è§†é¢‘æ’­æ”¾çš„åŠŸèƒ½ï¼Œç”¨åˆ°ä¸¤ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œç„¶åé‡åˆ°äº†ä¼ é€å¤±è´¥ï¼Œé€Ÿåº¦ä¸º0 çš„é—®é¢˜ï¼Œåªå¥½çœ‹ä¸‹æ•´ä¸ªåº“çš„æºç ï¼Œæ”¹ä¸‹bugï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ•´ä¸ªé€»è¾‘çš„æµç¨‹ç¬”è®°ã€‚</p>
<p>æ•´ä¸ªå±€åŸŸç½‘æ’­æ”¾æµç•…ä¸»è¦æ˜¯ä¸‹é¢çš„æµç¨‹</p>
<pre><code>å®¢æˆ·ç«¯ &lt;--- (socketé€šè®¯)---&gt;æœåŠ¡å™¨&lt;---(smbåè®®)---&gt;æŸå°å±€åŸŸç½‘ç”µè„‘
</code></pre><p>æˆ‘ä»¬çš„å®‰å“æ‰‹æœºå¦‚æœè¦æ’­æ”¾å±€åŸŸç½‘æŸå°ç”µè„‘ä¸Šçš„è§†é¢‘ï¼Œæˆ‘ä»¬éœ€è¦èµ·ä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œç”±è¿™ä¸ªæœåŠ¡å™¨å’Œæ’­æ”¾å™¨åšé€šè®¯ï¼Œæ ¹æ®æ’­æ”¾å™¨ å‘æ¥çš„è¯·æ±‚å¤´çš„<code>range</code>ï¼ˆç±»ä¼¼æ–­ç‚¹ç»­æˆçš„åŸç†ï¼‰ï¼Œæ¥åŠ è½½ç‰¹å®šçš„æ•°æ®ç»™æ’­æ”¾å™¨ã€‚<br>è€ŒæœåŠ¡å™¨çš„æ•°æ®æ˜¯ä»æŸå°å±€åŸŸç½‘ç”µè„‘ä¸Šè¯»å–çš„å•Šï¼Œåœ¨windowsä¸Šï¼Œæœ‰<code>smb</code>åè®®è´Ÿè´£å¤„ç†è¿™éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä»¬é ç€è¿™ä¸ªsmbåè®®å»é“¾æ¥ <code>æ•°æ®æº</code> ï¼Œå³æŸå°æœ‰æˆ‘ä»¬æƒ³è¦æ’­æ”¾çš„è§†é¢‘çš„é‚£å°ç”µè„‘ã€‚å»åŠ è½½æ’­æ”¾å™¨è¯·æ±‚çš„å†…å®¹ï¼Œç„¶åæ‰”å›ç»™æ’­æ”¾å™¨ã€‚</p>
<p>å¤§è‡´çš„æµç¨‹å°±æ˜¯ä¸Šé¢è¿™æ ·ã€‚è‡³äºå…·ä½“çš„ä»£ç ç»†èŠ‚ï¼Œåœ¨ä¸‹é¢ç»™å‡ºdemo</p>
<a id="more"></a>
<h1 id="èµ·èˆª"><a href="#èµ·èˆª" class="headerlink" title="èµ·èˆª"></a>èµ·èˆª</h1><p>é¦–å…ˆæ¥çœ‹ä¸‹æˆ‘ä»¬çš„httpæœåŠ¡å™¨éƒ¨åˆ†çš„å†…å®¹ï¼Œ</p>
<pre><code>SmbOverHttpService httpService = SmbOverHttpService.getInstance();
httpService.start();
</code></pre><p>å½“ç„¶å¼€å¤´å¾ˆç®€å•ï¼Œå°±æ˜¯å¯åŠ¨ä»–ï¼ŒèƒŒåå…·ä½“æ˜¯ä¸‹é¢è¿™æ ·</p>
<pre><code>public static int mBindPort = 0;
public static String mDefalutServerIP = &quot;127.0.0.1&quot;;
private int default_port=5356;


public boolean start() {
    if (isServing()) {
        return true;
    }
    int port = defalut_port;
    //å°è¯•å»ç»‘å®šä¸€ä¸ªç«¯å£ï¼Œå› ä¸ºæœ‰äº›ç«¯å£ä¼šè¢«éœ¸ç”¨ï¼Œ
    //æ‰€ä»¥è¿™é‡Œå†™äº†ä¸€ä¸ªå¾ªç¯å»è¯•
    while (mHttpServer == null) {
        HTTPServer httpServer = new HTTPServer(mDefalutServerIP, port);
        try {
            httpServer.start();
            mHttpServer=httpServer;
        } catch (IOException e) {
            e.printStackTrace();
        }

        if (mHttpServer != null) {
            mBindPort = port;
        }
        ++port;//ç»‘å®šé»˜è®¤ç«¯å£å¤±è´¥å°±ä¸€ç›´åŠ ï¼Œç„¶åç»§ç»­å°è¯•ç»‘å®šã€‚ç›´åˆ°æˆåŠŸ
    }
     return isServing();
  }

    public boolean isServing() {
        return mHttpServer != null;
    }
</code></pre><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ª HTTPServerçš„å†…å®¹</p>
<h2 id="httpServer"><a href="#httpServer" class="headerlink" title="httpServer"></a>httpServer</h2><pre><code>public class HTTPServer extends NanoHTTPD {

      public HTTPServer(String addr, int port) {
        super(addr, port);
     }

    @Override
    public Response serve(IHTTPSession session) {

         Method requestMethod = session.getMethod();
         String requestUri = session.getUri();

        if (requestMethod == Method.GET &amp;&amp; 
            requestUri.startsWith(SAMBA_PREFIX)) {

            return serveSamba(session);
        }

        return newFixedLengthResponse(Status.FORBIDDEN, 
                                        &quot;text/html&quot;, &quot;Forbidden&quot;);
    }

   private Response serveSamba(IHTTPSession session) {

        ...something
        ï¼ï¼åœ¨è¿™é‡Œæˆ‘ä»¬å»å¤„ç†æ’­æ”¾å™¨å‘æ¥çš„è¯·æ±‚ï¼Œé€šè¿‡smbè¯»å–è§†é¢‘çš„æ•°æ®è¿”å›ã€‚    
    }

    ...

}
</code></pre><p>æˆ‘ä»¬çš„serveræ˜¯ç»§æ‰¿<a href="https://github.com/NanoHttpd/nanohttpd" target="_blank" rel="noopener">NanoHTTPD</a>çš„ï¼Œä»–æ˜¯ä¸€ä¸ªéå¸¸ç®€æ˜“çš„httpåè®®å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§æ‰¿åéœ€è¦å¤„ç†çš„å°±æ˜¯å®ç°<code>server()</code>å‡½æ•°ï¼Œå»åˆ†ä¸åŒçš„æƒ…å†µä½œå¤„ç†ã€‚ç›®å‰æˆ‘ä»¬åªå¯¹getè¯·æ±‚çš„è¯»å–smbå†…å®¹ä½œå¤„ç†ã€‚å…·ä½“çš„å¤„ç†æˆ‘ä»¬ç°åœ¨å…ˆä¸çœ‹ï¼Œç»§ç»­å»çœ‹ä¸‹ç»‘å®šæ—¶å€™çš„<code>startï¼ˆï¼‰</code>å‡½æ•°èƒŒåçš„å†…å®¹</p>
<pre><code>public void start() throws IOException {
    start(NanoHTTPD.SOCKET_READ_TIMEOUT);
}

public void start(final int timeout) throws IOException {
    start(timeout, true);
}

public void start(final int timeout, boolean daemon) throws IOException {

    this.myServerSocket = this.getServerSocketFactory().create();
    this.myServerSocket.setReuseAddress(true);

    //åˆ›å»ºçš„è¿™ä¸ªæ–°çš„ServerRunnableå¯¹è±¡ï¼Œ
    //é€šè¿‡åå­—å°±å¯ä»¥çŒœåˆ°æ˜¯ä¸€ä¸ªrunnableå¯¹è±¡ï¼Œè¦ä¸ç„¶ä¹Ÿä¸ä¼šæ‰”åˆ°threadåšå‚æ•°äº†
    ServerRunnable serverRunnable = createServerRunnable(timeout);
    this.myThread = new Thread(serverRunnable);

    this.myThread.setDaemon(daemon);
    this.myThread.setName(&quot;NanoHttpd Main Listener&quot;);
    this.myThread.start();
    while (!serverRunnable.hasBinded() &amp;&amp;
             serverRunnable.getBindException() == null) {

        try {
            Thread.sleep(10L);
        } catch (Throwable e) {
            // on android this may not be allowed, that&apos;s why we
            // catch throwable the wait should be very short because we are
            // just waiting for the bind of the socket
        }

    }
    if (serverRunnable.getBindException() != null) {
        throw serverRunnable.getBindException();
    }
}
</code></pre><p>ä¸Šé¢æ•´ä¸ªèƒŒåçš„å¥—è·¯ï¼Œå…¶å®å°±æ˜¯åœ¨<code>ServerSocket.accept()</code> å¾—åˆ°ä¸€ä¸ªsocketåï¼Œå¼€ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼Œ<a href="http://blog.csdn.net/yangyi22/article/details/7523968" target="_blank" rel="noopener">å…·ä½“çœ‹è¿™ä»½å…¥é—¨demo</a>ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªåˆ›å»ºä¸€ä¸ªrunnableçš„å†…å®¹</p>
<h3 id="createServerRunnable"><a href="#createServerRunnable" class="headerlink" title="createServerRunnable"></a>createServerRunnable</h3><pre><code> protected ServerRunnable createServerRunnable(final int timeout) {
    return new ServerRunnable(this, timeout);
}
</code></pre><p> æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªserverRunnableå†…å®¹ï¼Œæ•´ä¸ªç±»ä¸å¤§ï¼Œå°±æ•´ä¸ªç²˜ä¸Šæ¥äº†ã€‚</p>
<pre><code>public class ServerRunnable implements Runnable {

    private NanoHTTPD httpd;
    private final int timeout;
    private IOException bindException;
    private boolean hasBinded = false;

    public ServerRunnable(NanoHTTPD httpd, int timeout) {
        this.httpd = httpd;
        this.timeout = timeout;
    }

    @Override
    public void run() {
        try {
            //æ˜¾ç„¶æˆ‘ä»¬æ˜¯æœ‰hostname=â€œ127.0.0.0â€çš„
             //å°±åœ¨è¿™ä¸€è¡Œï¼Œæˆ‘ä»¬è°ƒç”¨äº†ServerSocketå»ç»‘å®šhostname+port
              httpd.getMyServerSocket().bind(httpd.hostname != null ?
              new InetSocketAddress(httpd.hostname, httpd.myPort) :
              new InetSocketAddress(httpd.myPort));

            hasBinded = true;
        } catch (IOException e) {
            //å¦‚æœç»‘å®šå¤±è´¥ï¼Œå°±ä¿å­˜ä¸‹è¿™ä¸ªeï¼Œç„¶åä¸Šé¢å°±æ ¹æ®è¿™ä¸ªåšåˆ¤æ–­çœ‹æ˜¯å¦ç»‘å®šæˆåŠŸã€‚
            this.bindException = e;
            return;
        }

        do {
            try {
                //å‰é¢ç»‘å®šæˆåŠŸåï¼Œå°±è°ƒç”¨ServerSocketçš„acceptå‡½æ•°å»ç­‰å®¢æˆ·ç«¯æ¶ˆæ¯æ¥
                Socket finalAccept = httpd.getMyServerSocket().accept();
                if (this.timeout &gt; 0) {
                    finalAccept.setSoTimeout(this.timeout);
                }
                //æœ‰äº†æ¶ˆæ¯ï¼Œå°±æ‹¿inputStreamç»™å¼€ä¸€æ¡æ–°çš„çº¿ç¨‹å»å¤„ç†è¿™æ¬¡é€šè®¯ã€‚
                InputStream inputStream = finalAccept.getInputStream();
                httpd.asyncRunner.exec(httpd.createClientHandler(
                                        finalAccept, inputStream));

            } catch (IOException e) {
                log(Level.FINE, &quot;Communication with the client broken&quot;, e);
            }
        } while (!httpd.getMyServerSocket().isClosed());
        //è¿™é‡Œå†™äº†ä¸€ä¸ªå¾ªç¯åœ¨è¿™é‡Œï¼Œç›´åˆ°æœåŠ¡å™¨å…³äº†æ‰ä¸å†ç›‘å¬æ¶ˆæ¯ã€‚     
    }

    public IOException getBindException() {
        return bindException;
    }

    public boolean hasBinded() {
        return hasBinded;
    }
}
</code></pre><p>æˆ‘ä»¬çœ‹ä¸‹runå‡½æ•°é‡Œé¢ï¼Œæ‹¿ä»<code>ServerSocket.accept()</code>å¾—åˆ°çš„<code>socket</code>å¤„ç†éƒ¨åˆ†ï¼Œå°±æ˜¯ä¸‹é¢è¿™å¥</p>
<pre><code> httpd.asyncRunner.exec(httpd.createClientHandler(
                                       finalAccept, inputStream));


ClientHandler createClientHandler(Socket socket,InputStream inStream) {
   return new ClientHandler(this, inStream, socket);
 }
</code></pre><p>  å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„runnableå»å¤„ç†è¿™æ¬¡çš„å®¢æˆ·è¯·æ±‚</p>
<p>ç„¶åè¿™ä¸ªasyncRunner.exec å°±æ˜¯ä¸€ä¸ªå¥—å£³çš„threadå‡½æ•°ï¼Œæˆ‘ä»¬æˆªå–äº†æ ¸å¿ƒçš„ä»£ç æ®µã€‚</p>
<pre><code>@Override
public void exec(ClientHandler clientHandler) {
    ...
    createThread(clientHandler).start();
}

protected Thread createThread(ClientHandler clientHandler){
    Thread t = new Thread(clientHandler);
    t.setDaemon(true);
    t.setName(&quot;NanoHttpd Request Processor (#&quot; + this.requestCount + &quot;)&quot;);
    return t;
}    
</code></pre><p>æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å»çœ‹ä¸‹è¿™ä¸ªClientHandlerçš„runå‡½æ•°çš„å†…å®¹å§ï¼Œè¿™ä¸ªæ‰æ˜¯å…¨éƒ¨çš„é‡ç‚¹å†…å®¹</p>
<h3 id="ClientHandler"><a href="#ClientHandler" class="headerlink" title="ClientHandler"></a>ClientHandler</h3><pre><code>/**
 * The runnable that will be used for every new client connection.
 */
public class ClientHandler implements Runnable {

    private final NanoHTTPD httpd;
    private final InputStream inputStream;
    private final Socket acceptSocket;

    public ClientHandler(NanoHTTPD httpd, 
          InputStream inputStream, Socket acceptSocket) {

        this.httpd = httpd;
        this.inputStream = inputStream;
        this.acceptSocket = acceptSocket;
    }

    public void close() {
        NanoHTTPD.safeClose(this.inputStream);
        NanoHTTPD.safeClose(this.acceptSocket);
    }

    @Override
    public void run() {
        OutputStream outputStream = null;
        try {
            outputStream = this.acceptSocket.getOutputStream();

            ITempFileManager tempFileManager = 
                httpd.getTempFileManagerFactory().create();

            HTTPSession session = new HTTPSession(httpd, 
                tempFileManager, this.inputStream,outputStream, 
                this.acceptSocket.getInetAddress());

            //è¿™æ®µå°±æ˜¯æ„é€ äº†ä¸€ä¸ªsessionï¼Œæ¥ç€æ‰å“ŸåŠŸèƒ½executeï¼Œ
            //ä¼°è®¡ä¼šå›è°ƒåˆ°æˆ‘ä»¬å¼€å¤´å¤„ç†è¯·æ±‚çš„server()
            while (!this.acceptSocket.isClosed()) {
                session.execute();
            }

        } catch (Exception e) {
            // When the socket is closed by the client,
            // we throw our own SocketException to 
            // break the &quot;keep alive&quot; loop above. If
            // the exception was anything other than 
            //the expected SocketException OR a
            // SocketTimeoutException, print the  stacktrace

            if (!(e instanceof SocketException &amp;&amp;
                 &quot;NanoHttpd Shutdown&quot;.equals(e.getMessage())) &amp;&amp;
                  !(e instanceof SocketTimeoutException)) {

              log(Level.SEVERE, &quot;Communication with the client broken, 
                                         or an bug in the handler code&quot;, e);

            }

        } finally {
            NanoHTTPD.safeClose(outputStream);
            NanoHTTPD.safeClose(this.inputStream);
            NanoHTTPD.safeClose(this.acceptSocket);
            httpd.asyncRunner.closed(this);
        }
    }
}
</code></pre><h2 id="httpSession-execute"><a href="#httpSession-execute" class="headerlink" title="httpSession.execute()"></a>httpSession.execute()</h2><p>è¿™ä¸ªhttpSessionæœ‰ç‚¹é•¿ï¼Œä¸å¥½ç›´æ¥éƒ½ç²˜è´´ä¸Šæ¥ï¼Œæ¯•ç«Ÿæ•´ä¸ªè¯·æ±‚è§£æçš„å®ç°éƒ½æµ“ç¼©åœ¨è¿™é‡Œäº†</p>
<pre><code>public class HTTPSession implements IHTTPSession {

    ...

  public HTTPSession(NanoHTTPD httpd, ITempFileManager tempFileManager,
                     InputStream inputStream, OutputStream outputStream, 
                     InetAddress inetAddress) {
    ï¼ï¼ æŠŠæ„é€ å‡½æ•°è´´å‡ºæ¥ï¼Œç›´åˆ°å˜é‡çš„å…³ç³»ï¼Œä¾¿äºåé¢çš„executeå‡½æ•°å†…å®¹çš„ç†è§£
    this.httpd = httpd;
    this.tempFileManager = tempFileManager;
    this.inputStream = new BufferedInputStream(inputStream,
                                 HTTPSession.BUFSIZE);
    this.outputStream = outputStream;
    this.remoteIp = inetAddress.isLoopbackAddress() ||
                    inetAddress.isAnyLocalAddress() ?
                            &quot;127.0.0.1&quot; : 
                           inetAddress.getHostAddress().toString();

    this.remoteHostname = inetAddress.isLoopbackAddress() || 
                            inetAddress.isAnyLocalAddress() ?
                                    &quot;localhost&quot; : 
                                    inetAddress.getHostName().toString();

    this.headers = new HashMap&lt;String, String&gt;();
}

...

 @Override
 public void execute() throws IOException {
    Response r = null;
    try {

        byte[] buf = new byte[HTTPSession.BUFSIZE];
        this.splitbyte = 0;
        this.rlen = 0;
        int read = -1;
        this.inputStream.mark(HTTPSession.BUFSIZE);
        try {
            read = this.inputStream.read(buf, 0, HTTPSession.BUFSIZE);
        } catch (SSLException e) {
            throw e;
        } catch (IOException e) {
            NanoHTTPD.safeClose(this.inputStream);
            NanoHTTPD.safeClose(this.outputStream);
            throw new SocketException(&quot;NanoHttpd Shutdown&quot;);
        }

        //è¯»å–æ•°æ®åˆ°buféƒ¨åˆ†
        if (read == -1) {
            // socket was been closed
            NanoHTTPD.safeClose(this.inputStream);
            NanoHTTPD.safeClose(this.outputStream);
            throw new SocketException(&quot;NanoHttpd Shutdown&quot;);
        }
        while (read &gt; 0) {
            this.rlen += read;
            this.splitbyte = findHeaderEnd(buf, this.rlen);
            if (this.splitbyte &gt; 0) {
                break;
            }
            read = this.inputStream.read(buf, this.rlen, 
                                        HTTPSession.BUFSIZE - this.rlen);
        }

        if (this.splitbyte &lt; this.rlen) {
            this.inputStream.reset();
            this.inputStream.skip(this.splitbyte);
        }

        ï¼ï¼ä¸‹é¢å¼€å§‹æ˜¯ğŸ·éƒ¨è§£æ
        this.parms = new HashMap&lt;String, List&lt;String&gt;&gt;();
        if (null == this.headers) {
            this.headers = new HashMap&lt;String, String&gt;();
        } else {
            this.headers.clear();
        }
        // Create a BufferedReader for parsing the header.
        BufferedReader hin = new BufferedReader(new InputStreamReader(
                                                new ByteArrayInputStream(buf, 
                                                    0, this.rlen)));

        // Decode the header into parms and header java properties
        Map&lt;String, String&gt; pre = new HashMap&lt;String, String&gt;();
        decodeHeader(hin, pre, this.parms, this.headers);
        //å…·ä½“æ€ä¹ˆè§£ææˆ‘ä»¬è¿™æ¬¡ä¸å…³å¿ƒï¼Œä¸çœ‹ğŸ™ˆ 

        if (null != this.remoteIp) {
            this.headers.put(&quot;remote-addr&quot;, this.remoteIp);
            this.headers.put(&quot;http-client-ip&quot;, this.remoteIp);
        }

        //æ ¹æ®è§£æçš„ç»“æœï¼Œåˆå§‹åŒ–è¿™ä¸ªsession
        //è¿˜æ˜¯å¦èµ·ä¸€ä¸ªå‡½æ•°æ¥å¤„ç†å§ï¼Œä¸è¦éƒ½æ‰”åœ¨è¿™é‡Œï¼Œè¿™ä¸ªå‡½æ•°å·²ç»å¾ˆé•¿äº†
        this.method = Method.lookup(pre.get(&quot;method&quot;));           
        this.uri = pre.get(&quot;uri&quot;);
        this.cookies = new CookieHandler(this.headers);
        String connection = this.headers.get(&quot;connection&quot;);
        boolean keepAlive = &quot;HTTP/1.1&quot;.equals(protocolVersion)
                             &amp;&amp; (connection == null || 
                                 !connection.matches(&quot;(?i).*close.*&quot;));


         //æˆ‘ä»¬æ¯”è¾ƒå…³å¿ƒçš„å†…å®¹æ¥äº†ï¼Œé€šè¿‡å‰é¢çš„ä¸€å †è§£æï¼Œæ„é€ å¥½å¿…å¤‡çš„sessionä¿¡æ¯ï¼Œ
         //å°±å»å›è°ƒæˆ‘ä»¬çš„serveå‡½æ•°ï¼Œæˆ‘ä»¬å»å…·ä½“çš„å¤„ç†è¿™ä¸ªè¯·æ±‚
        r = httpd.serve(this);
           //å¤„ç†å®Œç”Ÿæˆä¸€ä¸ªResponeå¯¹è±¡ï¼Œæœ€åæˆ‘ä»¬åœ¨sendå‘é€ç»™å®¢æˆ·ç«¯

        if (r == null) {
            throw new NanoHTTPD.ResponseException(Status.INTERNAL_ERROR, 
                &quot;SERVER INTERNAL ERROR: Serve() returned a null response.&quot;);
        } else {
            String acceptEncoding = this.headers.get(&quot;accept-encoding&quot;);
            this.cookies.unloadQueue(r);
            r.setRequestMethod(this.method);
            r.setGzipEncoding(httpd.useGzipWhenAccepted(r) 
                              &amp;&amp; acceptEncoding != null
                              &amp;&amp; acceptEncoding.contains(&quot;gzip&quot;));

            r.setKeepAlive(keepAlive);
            r.send(this.outputStream);
            //ä¼šé€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
        }

        if (!keepAlive || r.isCloseConnection()) {
            throw new SocketException(&quot;NanoHttpd Shutdown&quot;);
        }

    } catch (Exception e) {
        ...
    } finally {
        NanoHTTPD.safeClose(r);
        this.tempFileManager.clear();
    }
}
</code></pre><p>çœ‹æˆ‘è¿™ä¸Šé¢çš„ä¸€å¤§ä¸²ï¼Œæˆ‘ä»¬æ¥ç¼•æ¸…ä¸‹æ€è·¯ï¼Œä¸»è¦å°±æ˜¯åœ¨acceptå¾—åˆ°socketåï¼Œæ ¹æ®socketå¾—åˆ°çš„inputStreamå»è¯»å®¢æˆ·ç«¯å‘é€æ¥çš„å†…å®¹ï¼Œæ¥ç€å°±æ˜¯è§£æï¼Œè§£æå¥½åæ˜¯å»serveå‡½æ•°å¤„ç†è¯·æ±‚ï¼Œå¤„ç†å¾—åˆ°ä¸€ä¸ªresponseç»“æœå†å›ä¼ ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æ˜ç™½ä¸Šé¢çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥å»çœ‹ä¸‹æ€ä¹ˆå¤„ç†è¿™ä¸ªè¯·æ±‚<br>æˆ‘ä»¬ç›´æ¥å°±æ¥çœ‹ä¸‹serveSambaçš„å†…å®¹å§</p>
<h2 id="serveSamba"><a href="#serveSamba" class="headerlink" title="serveSamba"></a>serveSamba</h2><pre><code> //å¯¹äºå¤„ç†smbåè®®çš„æ ¸å¿ƒå¤„ç†éƒ¨åˆ†ï¼Œ
//è·‘åˆ°è¿™é‡Œæ ¹æ®getè¯·æ±‚å¤´çš„rangeä¿¡æ¯ï¼Œä»smbFileå¯¹è±¡æ‹¿ä¿¡æ¯è¿”å›
private Response serveSamba(IHTTPSession session) {

    String reqUri = session.getUri();
    String base64EncodeSmbUri = reqUri.substring(SAMBA_PREFIX.length());
    byte[] smbUriBytes = Base64.decode(base64EncodeSmbUri, Base64.URL_SAFE);
    String smbUri = new String(smbUriBytes, Charset.forName(&quot;utf8&quot;));



    InputStream smbFileInputStream = null;
    long fileLength = 0;
    String filename = null; 
    SmbFile smbFile = new SmbFile(smbUri);

    if (smbFile!=null &amp;&amp; !smbFile.exists() || !smbFile.isFile()) {
        return newFixedLengthResponse(Status.NOT_FOUND, 
                          &quot;text/html&quot;, &quot;Not Found&quot;);
    }

    fileLength = smbFile.length();
    filename = smbFile.getName();
    smbFileInputStream = smbFile.getInputStream();

    ...

    boolean releaseSmbFileInputStream = true;
    try {
        Map&lt;String, String&gt; reqHeader = session.getHeaders();
        boolean hasHeaderRange = reqHeader.containsKey(&quot;range&quot;);

        long rangeBegin = 0;
        long rangeEnd = -1;
        if (hasHeaderRange) {
            //å¯¹äºè¯·æ±‚å¸¦rangeçš„ï¼Œå°±è§£æä¸‹
             String rangeValue = reqHeader.get(&quot;range&quot;);
             boolean parseRangeSuccess = false;
            if (rangeValue.startsWith(&quot;bytes=&quot;)) {
                int minus = rangeValue.indexOf(&apos;-&apos;);
                if (minus &gt; &quot;bytes=&quot;.length()) {                       
                   rangeBegin = Long.parseLong(
                            rangeValue.substring(&quot;bytes=&quot;.length(), minus));
                    rangeEnd = Long.parseLong(
                            rangeValue.substring(minus + 1));                         
                    parseRangeSuccess = true;
                }
            }

            ...
        }

        //è·å–è¯·æ±‚æ–‡ä»¶çš„ç±»å‹aviï¼Œmp4ç­‰
        String mimeType = null;
        if (filename != null) {
            int pos = filename.lastIndexOf(&apos;.&apos;);
            if (pos &gt; 0) {
                mimeType = fileExtNameToMIMEType(
                            filename.substring(pos + 1));
            }
        }

        //å¯¹äºè¯·æ±‚æ²¡å¸¦rangeçš„ï¼Œå°±æ˜¯é»˜è®¤çš„[0-fileLength]
        Response res = null;
        if (rangeEnd &lt; 0) {
            rangeEnd = (fileLength &gt; 0 ? fileLength - 1 : 0);
        }


        long resContentLength = rangeEnd - rangeBegin + 1;
        if (hasHeaderRange) {
            //ä¸‹é¢æ ¹æ®è¯·æ±‚çš„rangeå»è¿”å›å¯¹åº”çš„æ•°æ®ç»™å®¢æˆ·ç«¯
            smbFileInputStream.skip(rangeBegin);

            res = newFixedLengthResponse(Status.PARTIAL_CONTENT, mimeType, 
                                    smbFileInputStream, resContentLength);
            res.addHeader(&quot;Accept-Ranges&quot;, &quot;bytes&quot;);
            res.addHeader(&quot;Content-Range&quot;, 
                            &quot;bytes &quot; + rangeBegin + &quot;-&quot; + 
                            rangeEnd + &quot;/&quot; + fileLength);
        } else {//ä¸åŠ rangeçš„å°±æ•´ä¸ªæµé€å›å»
            res = newFixedLengthResponse(Status.OK, mimeType, 
                            smbFileInputStream, resContentLength);
        }

        res.addHeader(&quot;Content-Length&quot;, &quot;&quot; + resContentLength);
        releaseSmbFileInputStream = false;
        return res;//åˆ°æ­¤é¡ºåˆ©çš„æ„é€ å¥½ä¸€ä¸ªResponeï¼Œå¯ä»¥è¿”å›ç»™å®¢æˆ·ç«¯äº†

     }catch (Exception e){
        Log.i(TAG, &quot;serveSamba: try read fail -&gt; &quot;+e.toString());
        return newFixedLengthResponse(Status.NOT_FOUND, 
                                    &quot;text/html&quot;, &quot;Not Found&quot;);
     }finally {
        if (releaseSmbFileInputStream &amp;&amp; smbFileInputStream != null) {
            smbFileInputStream.close();//æœ€åè®°å¾—å…³é—­æ–‡ä»¶æµï¼
        }

    }
}
</code></pre><p>çœ‹å®Œæ„é€ responseï¼Œè¿™éƒ¨åˆ†å°±æ˜¯å’Œå±€åŸŸç½‘çš„æ•°æ®æ²Ÿé€šéƒ¨åˆ†å†…å®¹ï¼Œå¾ˆç®€å•çš„æ„Ÿè§‰ä¸æ˜¯å—ï¼Ÿã€‚<br>ä¸€ä¸ªå°è£…å¥½äº†çš„SmbFileå¯¹è±¡ï¼Œæ›¾ç»è‡ªå·±å†™äº†ä¸€ä¸ªç±»ä¼¼çš„ï¼Œå®åœ¨æ˜¯ä¸å ªé‡è´ŸğŸ™ˆæœ€åæ‰¾è¿™ä¸ªç¬¬ä¸‰æ–¹åŒ…</p>
<h2 id="respone-send"><a href="#respone-send" class="headerlink" title="respone.send"></a>respone.send</h2><p>æˆ‘ä»¬çœ‹æœ€åçš„é€å›å»ç»™å®¢æˆ·ç«¯çš„éƒ¨åˆ†</p>
<pre><code>  /**
 * Sends given response to the socket.
 */
public void send(OutputStream outputStream) {

    //ä¸‹é¢ä¸€å¤§ä¸²å°±æ˜¯æ„é€ å¤´éƒ¨å†…å®¹ï¼Œä¸ºä½•ä¸å•ç‹¬ä¸€ä¸ªå‡½æ•°é‡Œé¢...
    SimpleDateFormat gmtFrmt = new SimpleDateFormat(
                &quot;E, d MMM yyyy HH:mm:ss &apos;GMT&apos;&quot;, Locale.US);                                                                                                 

    gmtFrmt.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));

    try {
        if (this.status == null) {
            throw new Error(&quot;sendResponse(): Status can&apos;t be null.&quot;);
        }

        //æ„é€ ä¸€ä¸ªwriterå®åœ¨æ˜¯å¤ªé•¿äº†
        PrintWriter pw = new PrintWriter(
            new BufferedWriter(
             new OutputStreamWriter(outputStream, 
            new ContentType(this.mimeType).getEncoding())), false);

        //ä½¿ç”¨1.1åè®®ï¼Œè¯è¯´ç°åœ¨2.0éƒ½å‡ºæ¥äº†ï¼Œè§£å†³é˜Ÿé¦–å µå¡ç­‰é—®é¢˜ã€‚                            
        pw.append(&quot;HTTP/1.1 &quot;).
            append(this.status.getDescription()).append(&quot; \r\n&quot;);

        if (this.mimeType != null) {
            printHeader(pw, &quot;Content-Type&quot;, this.mimeType);
        }
        if (getHeader(&quot;date&quot;) == null) {
            printHeader(pw, &quot;Date&quot;, gmtFrmt.format(new Date()));
        }

        for (String cookieHeader : this.cookieHeaders) {
            printHeader(pw, &quot;Set-Cookie&quot;, cookieHeader);
        }

        if (getHeader(&quot;connection&quot;) == null) {
            printHeader(pw, &quot;Connection&quot;, (this.keepAlive ? 
                                                    &quot;keep-alive&quot; : &quot;close&quot;));
        }

        if (getHeader(&quot;content-length&quot;) != null) {
            encodeAsGzip = false;
        }

         //æˆ‘ä»¬æ˜¯æœ‰lengthçš„ï¼Œæ‰€ä»¥ä¸é€‚ç”¨gzipï¼Œè€Œä¸”ä¸æ˜¯chunkedTransfer

        if (encodeAsGzip) {
            printHeader(pw, &quot;Content-Encoding&quot;, &quot;gzip&quot;);
            setChunkedTransfer(true);
        }

            /ï¼è‡´äºè¿™ä¸ªpendingï¼Œå½“ç„¶åœ¨æˆ‘ä»¬çš„æƒ…å†µï¼Œæ’­æ”¾è§†é¢‘çš„èƒŒæ™¯ä¸‹
            //dataä¸ºçœŸï¼Œç”¨contentLength
        long pending = this.data != null ? this.contentLength : 0;

        if (this.requestMethod != Method.HEAD &amp;&amp; this.chunkedTransfer) {
            printHeader(pw, &quot;Transfer-Encoding&quot;, &quot;chunked&quot;);
        } else if (!encodeAsGzip) {
            pending = 
                    sendContentLengthHeaderIfNotAlreadyPresent(pw, pending);
        }

        pw.append(&quot;\r\n&quot;);
        pw.flush();

        sendBodyWithCorrectTransferAndEncoding(outputStream, pending);

        //å†™å®Œflushï¼Œå‘é€ã€‚
        outputStream.flush();
        NanoHTTPD.safeClose(this.data);

    } catch (IOException ioe) {
        NanoHTTPD.LOG.log(Level.SEVERE, &quot;Could not send response to the client&quot;, ioe);
    }
}

private void sendBodyWithCorrectTransferAndEncoding(
            OutputStream outputStream, long pending) throws IOException {

    if (this.requestMethod != Method.HEAD &amp;&amp; this.chunkedTransfer) {
        ChunkedOutputStream chunkedOutputStream = 
                new ChunkedOutputStream(outputStream);

        sendBodyWithCorrectEncoding(chunkedOutputStream, -1);
        chunkedOutputStream.finish();
    } else {
        //èµ°è¿™ä¸ªåˆ†æ”¯ï¼ŒchunkedTransferä¸ºfasle
        sendBodyWithCorrectEncoding(outputStream, pending);
    }
}

private void sendBodyWithCorrectEncoding(
        OutputStream outputStream, long pending) throws IOException {

    if (encodeAsGzip) {
        GZIPOutputStream gzipOutputStream = 
           new GZIPOutputStream(outputStream);

        sendBody(gzipOutputStream, -1);
        gzipOutputStream.finish();

    } else {
        //è¿™ä¸ªåˆ†æ”¯ï¼Œæˆ‘ä»¬ä¸ç”¨gzip
        sendBody(outputStream, pending);
    }
}

/**
 * Sends the body to the specified OutputStream. 
 * The pending parameter
 * limits the maximum amounts of bytes sent unless it is -1,
 *  in which case everything is sent. 
 */
private void sendBody(OutputStream outputStream, long pending)
     throws IOException {

    long BUFFER_SIZE = 16 * 1024;
    //ç„¶åéœ€è¦è¯´ä¸‹è¿™ä¸ªç¼“å†²å¤§å°
    //æ ¹æ®è‡ªå·±å®é™…è°ƒæ•´ä¸‹å¤§å°ã€‚

    byte[] buff = new byte[(int) BUFFER_SIZE];
    boolean sendEverything = pending == -1;
    //æ¥ä¸‹æ¥è¿™éƒ¨åˆ†å°±æ˜¯å¾ªç¯è¯»æ•°æ®ï¼Œæ¯æ¬¡è¯»bufferSizeçš„å¤§å°ï¼Œç„¶åé€ç»™å®¢æˆ·ç«¯
    //ç›´åˆ°è¯»å®Œï¼Œå°±ç®—ç»“æŸæ‰è¿™æ¬¡çš„socketè¯·æ±‚äº†ã€‚

    while (pending &gt; 0 || sendEverything) {
        long bytesToRead = sendEverything ? BUFFER_SIZE : Math.min(pending, BUFFER_SIZE);
        int read = this.data.read(buff, 0, (int) bytesToRead);
        if (read &lt;= 0) {
            break;
        }
        outputStream.write(buff, 0, read);
        if (!sendEverything) {
            pending -= read;
        }
    }
}
</code></pre><p>å¥½äº†ï¼Œæ•´ä¸ªæµç¨‹å°±è¿™æ ·çœ‹æˆ‘äº†ï¼Œæ•´ä¸ªdemoä¹ŸåŸºæœ¬æ ¸å¿ƒçš„éƒ½è´´å‡ºæ¥äº†ã€‚</p>
<p>çœ‹æˆ‘æ•´ä¸ªæµç¨‹ï¼Œç†è®ºä¸Šä¸€ä¸ªè§†é¢‘çš„æ’­æ”¾æµä¸æµç•…çš„å…³é”®ï¼Œå³ç“¶é¢ˆæˆ‘ä»¬ä¹ŸçŸ¥é“åœ¨å“ªé‡Œäº†ï¼Œ<br>ä¸€èˆ¬ä¸»è¦è€—è´¹çš„æ—¶é—´ä¸€èˆ¬éƒ½åœ¨sendBody(ï¼‰è¿™ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚å½“ä½ çš„pendingå°±æ˜¯æ–‡ä»¶å¤§å°ï¼Œå³ä½ çš„rangeå°±æ˜¯0-fileSizeçš„æ—¶å€™ã€‚<br>é‚£ä¹ˆåˆ°åº•è¦æ€ä¹ˆæ”¹è¿›æ€§èƒ½å‘¢ï¼Ÿ</p>
<p>æ”¹è¿›æ€§èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œæœ€å¥½æœ‰ä¸€äº›å·¥å…·å¸®åŠ©ä½ å»é‡åŒ–ï¼Œæµ‹é‡ç»“æœã€‚<br>ä»å†…å­˜ï¼Œè€—æ—¶ï¼Œç½‘ç»œå¸¦å®½ç­‰ç­‰å¤šæ–¹é¢è€ƒå¯Ÿï¼ŒAndroid studioå¸¦çš„monitorå·¥å…·å°±æ˜¯ä¸€ä¸ªæŒºå¥½çš„å¸®æ‰‹ï¼Œå…·ä½“è§æˆ‘å‰é¢çš„æ–‡ç« ã€‚</p>
<ol>
<li><p>æ’­æ”¾å™¨å†…æ ¸ç›´æ¥æ”¯æŒ<br>å…³äºå±€åŸŸç½‘æ’­æ”¾ï¼Œåœ¨å¤„ç†ä¸€äº›å°è§†é¢‘è¿˜å¥½ï¼Œè¦æ˜¯é‡åˆ°ä¸€äº›è¶…é«˜ç ç‡çš„ï¼Œä¾‹å¦‚é‚£äº›1Gå¤§å°çš„è§†é¢‘å±…ç„¶åªæœ‰å‡ åç§’çš„é‚£äº›ã€‚<br>é‚£ä¹ˆå‡è®¾ä¸€ä¸ªä¸­é—´è½¬æ¥çš„æœåŠ¡å™¨æ˜¯ä¸å¤ªåˆé€‚çš„ï¼Œæœ€å¥½å°±æ˜¯è®©æ’­æ”¾å™¨ç›´æ¥æ”¯æŒå±€åŸŸç½‘æ’­æ”¾ã€‚<br>æ¯•ç«Ÿåƒä¸Šé¢è¿™æ ·ï¼Œè¯»å–å®Œï¼Œå†å†™å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å†æ’­æ”¾å‡ºæ¥ï¼Œå’Œ å®¢æˆ·ç«¯ç›´æ¥æ’­æ”¾å™¨è¯»å–æ’­æ”¾æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
</li>
<li><p>å¼€å¤šä¸ªè¯·æ±‚<br>ä»¥ä¸Šæ˜¯åŸºäºæ¯æ¬¡è¯·æ±‚çš„rangeä¸º0-fileSizeçš„æ•´ä¸ªæ–‡ä»¶å¤§å°é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åƒå¤šç‚¹ç»­ä¼ ä¸€æ ·ï¼Œè®©æ’­æ”¾å™¨å¤šå‘ç‚¹è¯·æ±‚ï¼Œå¤šçº¿ç¨‹å»åŠ æ•°æ®å›æ¥ï¼Œå°½é‡æŠŠå¸¦å®½éƒ½éœ¸å æ»¡ã€‚</p>
</li>
<li><p>æ’­æ”¾å†…æ ¸ä¸æ”¯æŒï¼Œå°±æ”¹è¿›ç¼“å­˜å¤§å°<br>ç¼“å†²å¤§å°è¿™ä¸ªæ˜¯å¾ˆç›´æ¥çš„å› ç´ ï¼Œä¾‹å¦‚ä¸Šé¢å†™æ­»äº†æ˜¯16kBã€‚ä½†æœ€å¥½è¿˜æ˜¯åŠ¨æ€æ¥è°ƒå¯èƒ½æ˜¯æœ€å¥½çš„ï¼Œæ¯•ç«Ÿè¿™ä¸ªç›´è§‰ä¸Šæˆ‘ä»¬èƒ½å¤ŸçŸ¥é“æ˜¯å—æœåŠ¡å™¨çš„iopsï¼Œç½‘é€Ÿï¼Œå®¢æˆ·ç«¯çš„è¯»å–é€Ÿåº¦ç­‰å¤šæ–¹é¢å½±å“çš„ã€‚å¦‚æœæ˜¯åƒå…†å…‰è°¦ï¼Œssdç›˜ï¼Œæˆ‘ä»¬è®¾ç½®ç¼“å†²1kbï¼Œé‚£å°±æœ‰ç‚¹æµªè´¹äº†ã€‚æ‰€ä»¥æ ¹æ®å®é™…çš„æœåŠ¡å™¨æƒ…å†µï¼Œå¸¦å®½ï¼Œç£ç›˜ioæƒ…å†µæ¥è®¾ç½®è¿™ä¸ªç¼“å†²å¤§å°ä¼šæ›´åˆé€‚ã€‚å½“ç„¶æˆ‘ä»¬çœ‹åˆ°å¦‚æœæŠŠåˆ¤æ–­æ¡ä»¶æ”¹ä¸‹ï¼Œæ˜¯å¦ä¼šç¼©çŸ­ä¸€ç‚¹ç‚¹æ—¶é—´å‘¢ï¼Ÿ</p>
</li>
<li><p>æ”¹è¿›jcifs<br>æˆ‘ä»¬æ˜¯é€šè¿‡jcifsè¿™ä¸ªå®ç°smbåè®®çš„åº“æ¥å’Œå±€åŸŸç½‘çš„ç”µè„‘äº¤äº’ï¼Œè¯»å–æ•°æ®ç­‰ã€‚é‚£ä¹ˆç†è®ºä¸Šè¿™é‡Œé¢å¿…ç„¶ä¼šæœ‰ä¸€äº›ä¼˜åŒ–çš„åœ°æ­¥ï¼Œè‡´äºå…·ä½“çš„ï¼Œå°±é è¯»è€…ä½ è‡ªå·±åˆ†æäº†ã€‚<br>Linuxç³»ç»Ÿé»˜è®¤è‡ªå¸¦çš„Sambaï¼Œéƒ½æœ‰ä¼˜åŒ–çš„é…ç½®æ–‡ä»¶ï¼Œä¼°è®¡jcifsä¹Ÿä¼šæœ‰ï¼Œä¸è¿‡å¥½åƒåœ¨å®˜ç½‘æ²¡æ³¨æ„åˆ°æœ‰ã€‚</p>
</li>
</ol>
<h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><ol>
<li><a href="https://github.com/NanoHttpd/nanohttpd" target="_blank" rel="noopener">nanoHttpd</a>ï¼Œhttp æœåŠ¡å™¨æ˜¯ç”¨äº†è¿™ä¸ªé¡¹ç›®çš„å†…å®¹</li>
<li><a href="https://jcifs.samba.org/" target="_blank" rel="noopener">jcifs</a>ï¼ŒJCIFS is an Open Source client library that implements the CIFS/SMB networking protocol in 100% Java. CIFS is the standard file sharing protocol on the Microsoft Windows platform (e.g. Map Network Drive â€¦). This client is used extensively in production on large Intranets.</li>
</ol>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag">#android</a>
          
            <a href="/tags/socket/" rel="tag">#socket</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/13/åœ¨ç¦»å¼€ä¸¤å¹´åçš„å½’æ¥/" rel="prev">ç¦»å¼€ä¸¤å¹´åçš„å½’æ¥</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/27/æºç æ¢ç´¢ç³»åˆ—44---å…³äºAMçš„forceStopPackage/" rel="next">æºç æ¢ç´¢ç³»åˆ—44---å…³äºAMçš„forceStopPackage</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/10/08/æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¹‹ServerSocketä¸SMB/"
     data-title="æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¸ServerSocket"
     data-content=""
     data-url="http://yoursite.com/2016/10/08/æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¹‹ServerSocketä¸SMB/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">åˆ†äº«åˆ°ï¼š</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">å¾®åš</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQç©ºé—´</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">è…¾è®¯å¾®åš</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">å¾®ä¿¡</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>

 </div>

        
            <!-- å¤šè¯´çƒ­è¯„æ–‡ç« -->
            <p>çƒ­è¯„æ–‡ç« </p>
            <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>
        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2016/10/08/æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¹‹ServerSocketä¸SMB/"
                   data-title="æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¸ServerSocket" data-url="http://yoursite.com/2016/10/08/æºç æ¢ç´¢ç³»åˆ—45---å…³äºå±€åŸŸç½‘æ’­æ”¾ä¹‹ServerSocketä¸SMB/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table Of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/myAvatar.jpg" alt="SanjayF" itemprop="image"/>
          <p class="site-author-name" itemprop="name">SanjayF</p>
        </div>
        <p class="site-description motion-element" itemprop="description">SanjayF's  github  blog</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">105</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">119</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#èµ·èˆª"><span class="nav-number">1.</span> <span class="nav-text">èµ·èˆª</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#httpServer"><span class="nav-number">1.1.</span> <span class="nav-text">httpServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#createServerRunnable"><span class="nav-number">1.1.1.</span> <span class="nav-text">createServerRunnable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ClientHandler"><span class="nav-number">1.1.2.</span> <span class="nav-text">ClientHandler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#httpSession-execute"><span class="nav-number">1.2.</span> <span class="nav-text">httpSession.execute()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serveSamba"><span class="nav-number">1.3.</span> <span class="nav-text">serveSamba</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#respone-send"><span class="nav-number">1.4.</span> <span class="nav-text">respone.send</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ref"><span class="nav-number">2.</span> <span class="nav-text">ref</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SanjayF</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"sanjayf"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
