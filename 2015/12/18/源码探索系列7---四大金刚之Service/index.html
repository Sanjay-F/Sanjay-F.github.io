<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="SanjayF's  github  blog" />



  <meta name="keywords" content="android,源码,service," />





  <link rel="shorticon icon" type="image/x-icon" href="/fav.ico?v=0.4.5.1" />


<meta name="description" content="今天我们来看下这安卓的四大组件的另外一个Service，按套路应该先列点我们在探索过程需要注意的问题，不过现在一时没想到有什么，让我们边看说解释，看下有什么需要注意的 起航—-开启服务API ： 23 我们启动服务一般有两种调用StartService和BindService,这里我们先从StartService开始。首先去到ContextWrapper里面的startService函数 @Ove">
<meta name="keywords" content="android,源码,service">
<meta property="og:type" content="article">
<meta property="og:title" content="源码探索系列7---四大金刚之Service">
<meta property="og:url" content="http://yoursite.com/2015/12/18/源码探索系列7---四大金刚之Service/index.html">
<meta property="og:site_name" content="SanjayF&#39;s blog">
<meta property="og:description" content="今天我们来看下这安卓的四大组件的另外一个Service，按套路应该先列点我们在探索过程需要注意的问题，不过现在一时没想到有什么，让我们边看说解释，看下有什么需要注意的 起航—-开启服务API ： 23 我们启动服务一般有两种调用StartService和BindService,这里我们先从StartService开始。首先去到ContextWrapper里面的startService函数 @Ove">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-09-13T03:59:42.732Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="源码探索系列7---四大金刚之Service">
<meta name="twitter:description" content="今天我们来看下这安卓的四大组件的另外一个Service，按套路应该先列点我们在探索过程需要注意的问题，不过现在一时没想到有什么，让我们边看说解释，看下有什么需要注意的 起航—-开启服务API ： 23 我们启动服务一般有两种调用StartService和BindService,这里我们先从StartService开始。首先去到ContextWrapper里面的startService函数 @Ove">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> 源码探索系列7---四大金刚之Service | SanjayF's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?18f6d52faaf2600c05e8045494b5935e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>

      <span class="site-title">SanjayF's blog</span>
        <h6 id="subtitle-wrap">
           <span class="site-nav">生命不息，装逼不止</span>    
        </h6>
       
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            Tags
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'qy4B6rmn6sA3Kyx-8Ysw','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              源码探索系列7---四大金刚之Service
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-12-18T12:57:00+08:00" content="2015-12-18">
            2015-12-18
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/android/" itemprop="url" rel="index">
                  <span itemprop="name">android</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/12/18/源码探索系列7---四大金刚之Service/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/18/源码探索系列7---四大金刚之Service/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>今天我们来看下这安卓的四大组件的另外一个Service，<br>按套路应该先列点我们在探索过程需要注意的问题，不过现在一时没想到有什么，<br>让我们边看说解释，看下有什么需要注意的</p>
<h1 id="起航—-开启服务"><a href="#起航—-开启服务" class="headerlink" title="起航—-开启服务"></a>起航—-开启服务</h1><p>API ： 23</p>
<p>我们启动服务一般有两种调用<code>StartService</code>和<code>BindService</code>,这里我们先从StartService开始。<br>首先去到ContextWrapper里面的startService函数</p>
<pre><code>@Override
public ComponentName startService(Intent service) {
    return mBase.startService(service);
}
</code></pre><a id="more"></a>
<p>这个我们在前一篇也分析广播时候也遇到过类似情况，这个mBase的具体实现是ContextImpl，我们继续看下</p>
<pre><code>@Override
public ComponentName startService(Intent service) {
    warnIfCallingFromSystemProcess();
    return startServiceCommon(service, mUser);
}

private ComponentName startServiceCommon(Intent service, UserHandle user) {
    try {
        validateServiceIntent(service);
        service.prepareToLeaveProcess();
        ComponentName cn = ActivityManagerNative.getDefault().startService(
            mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(
                        getContentResolver()), getOpPackageName(), user.getIdentifier());

           ...
        return cn;
    } catch (RemoteException e) {
        throw new RuntimeException(&quot;Failure from system&quot;, e);
    }
}
</code></pre><p>好吧，看到这个AMN，最近我们都看到他，已经在熟悉不过了，他的实现是AMS，我们就跑去哪里再看下那个startService里面做了什么吧</p>
<pre><code>    @Override
public ComponentName startService(IApplicationThread caller, Intent service,
        String resolvedType, String callingPackage, int userId)
        throws TransactionTooLargeException {
    enforceNotIsolatedCaller(&quot;startService&quot;);

      ...

    synchronized(this) {
        final int callingPid = Binder.getCallingPid();
        final int callingUid = Binder.getCallingUid();
        final long origId = Binder.clearCallingIdentity();
        ComponentName res = mServices.startServiceLocked(caller, service,
                resolvedType, callingPid, callingUid, callingPackage, userId);
        Binder.restoreCallingIdentity(origId);
        return res;
    }
}
</code></pre><p>他在底层去调用了<code>ActivityService.startServiceLocked()</code>,感觉这个命名格式也很有熟悉感啊，来我们继续看下他做了什么</p>
<pre><code> ComponentName startServiceLocked(IApplicationThread caller, Intent service, String resolvedType,
        int callingPid, int callingUid, String callingPackage, int userId)
        throws TransactionTooLargeException {

    ServiceLookupResult res =
        retrieveServiceLocked(service, resolvedType, callingPackage,
                callingPid, callingUid, userId, true, callerFg);

    ServiceRecord r = res.record;

     ...
    return startServiceInnerLocked(smap, service, r, callerFg, addToStarting);
}
</code></pre><p>经过一对的处理，他最后调用了startServiceInnerLocked（）；</p>
<pre><code> ComponentName startServiceInnerLocked(ServiceMap smap, Intent service, ServiceRecord r,
        boolean callerFg, boolean addToStarting) throws TransactionTooLargeException {
     ...
    String error = bringUpServiceLocked(r, service.getFlags(), callerFg, false);
    if (error != null) {
        return new ComponentName(&quot;!!&quot;, error);
    }

    ...
    return r.name;
}
</code></pre><p>继续看下里面的内容</p>
<pre><code>private final String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg,
        boolean whileRestarting) throws TransactionTooLargeException {

       ...
       app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);
       realStartServiceLocked(r, app, execInFg);
       ...

}
</code></pre><p>哈，<code>realStartServiceLocked</code>这名字看起来，前面都是骗人的启动过程，现在才开始干真活的样子</p>
<pre><code>private final void realStartServiceLocked(ServiceRecord r,
       ProcessRecord app, boolean execInFg) throws RemoteException {

        ... 
   try {
       ...

       mAm.ensurePackageDexOpt(r.serviceInfo.packageName);
       app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);
       app.thread.scheduleCreateService(r, r.serviceInfo,
               mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),
               app.repProcState);
       r.postNotification();
       created = true;
   } catch (DeadObjectException e) {
       ...
   }

   requestServiceBindingsLocked(r, execInFg);

   updateServiceClientActivitiesLocked(app, null, true);

   // If the service is in the started state, and there are no
   // pending arguments, then fake up one so its onStartCommand() will
   // be called.
   if (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == 0) {
       r.pendingStarts.add(new ServiceRecord.StartItem(r, false, r.makeNextStartId(),
               null, null));
   }

   sendServiceArgsLocked(r, execInFg, true);

   ...
}
</code></pre><p>   好了，截取掉一部分不相干的消息，我们现在看下他实际做了什么，我们看到了他是去调用app.thread.scheduleCreateService(）函数去执行service的，这个我们前篇文章有看到过这个app.thread，最终干活的是ActivityThread里的一个ApplicationThread。让我们去看下他实际干了什么。<br> 另外结尾也有注释，如果service已启动且没Pending arguments，那是去调用了他<code>onStartCommand()</code><br>好了，还是就像去看下主线任务吧</p>
<pre><code>public final void scheduleCreateService(IBinder token,
            ServiceInfo info, CompatibilityInfo compatInfo, int processState) {
        updateProcessState(processState, false);
        CreateServiceData s = new CreateServiceData();
        s.token = token;
        s.info = info;
        s.compatInfo = compatInfo;

        sendMessage(H.CREATE_SERVICE, s);
    }
</code></pre><p>我们的”H“显示似乎又要登场了，靠他来发送一个创建服务的消息来干活。</p>
<pre><code>private void sendMessage(int what, Object obj) {
    sendMessage(what, obj, 0, 0, false);
}

private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) {

    Message msg = Message.obtain();
    msg.what = what;
    msg.obj = obj;
    msg.arg1 = arg1;
    msg.arg2 = arg2;
    if (async) {
        msg.setAsynchronous(true);
    }
    mH.sendMessage(msg);
}
</code></pre><p>确实是去调用我们的H朋友去发送消息去了，我们看下消息里面调用的<code>handleCreateService((CreateServiceData)msg.obj)</code>具体做了什么</p>
<pre><code>private void handleCreateService(CreateServiceData data) { 

    LoadedApk packageInfo = getPackageInfoNoCheck(
            data.info.applicationInfo, data.compatInfo);
    Service service = null;

    java.lang.ClassLoader cl = packageInfo.getClassLoader();
    service = (Service) cl.loadClass(data.info.name).newInstance();

    ContextImpl context = ContextImpl.createAppContext(this, packageInfo);
    context.setOuterContext(service);

    Application app = packageInfo.makeApplication(false, mInstrumentation);
    service.attach(context, this, data.info.name, data.token, app,
             ActivityManagerNative.getDefault());
    service.onCreate();
    mServices.put(data.token, service);

    ActivityManagerNative.getDefault().serviceDoneExecuting(
               data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);

}
</code></pre><p>为何方便看，精简了下代码，从上面的代码可以看到，到这里用ClassLoader去启动了服务，配置了下Context，这个就是我们然后调用了服务的onCreate方法。好了，这样我们的启动过程基本就到这里了。</p>
<p>另外，我们知道onCreate函数执行完后，就是到了onStartCommand（）啦，不过这个过程好像没看到啊？跑去哪里了呢？</p>
<p>这是因为还有一部分代码没说，重新回到我们的 真 · 干活的<code>realStartServiceLocked</code>函数的地步，有这么一个函数我留着  <code>sendServiceArgsLocked(r, execInFg, true);</code>　，他的作用就是发送参数，让我们看下这部分内容</p>
<pre><code> private final void sendServiceArgsLocked(ServiceRecord r, boolean execInFg,
        boolean oomAdjusted) throws TransactionTooLargeException {
   ...
   r.app.thread.scheduleServiceArgs(r, si.taskRemoved, si.id, flags, si.intent);
   ．．． 　
}
</code></pre><p>只留下最重要的一句话，就是调度发送service的参数</p>
<pre><code>public final void scheduleServiceArgs(IBinder token, boolean taskRemoved, int startId,
        int flags ,Intent args) {
        ServiceArgsData s = new ServiceArgsData();
        s.token = token;
        s.taskRemoved = taskRemoved;
        s.startId = startId;
        s.flags = flags;
        s.args = args;

        sendMessage(H.SERVICE_ARGS, s);
    }
</code></pre><p>这个复杂发送了一个消息回去，代码在下面</p>
<pre><code>private void handleServiceArgs(ServiceArgsData data) {
    Service s = mServices.get(data.token);
    if (s != null) {

        if (data.args != null) {
            data.args.setExtrasClassLoader(s.getClassLoader());
            data.args.prepareToEnterProcess();
        }
        int res;
        if (!data.taskRemoved) {
            res = s.onStartCommand(data.args, data.flags, data.startId);
        } else {
            s.onTaskRemoved(data.args);
            res = Service.START_TASK_REMOVED_COMPLETE;
        }
        ...
   }
}
</code></pre><p>好了，这样我们的onStartCommannd也就集齐了。<br>整个流程算跑完一半了。</p>
<h1 id="前进—-—-停止服务"><a href="#前进—-—-停止服务" class="headerlink" title="前进— — 停止服务"></a>前进— — 停止服务</h1><p>在开始看过程前，我们来猜下他打开的过程，应该最后也是跑回到H里面执行一个什么<code>STOP_SERVICE</code>消息。带着这个猜想，我们偷下懒，直接从我们的H先生哪里看下消息列表，看下有没我们想要的</p>
<pre><code>case CREATE_SERVICE:
    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceCreate&quot;);
    handleCreateService((CreateServiceData)msg.obj);
    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
    break;
case BIND_SERVICE:
    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceBind&quot;);
    handleBindService((BindServiceData)msg.obj);
    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
    break;
case UNBIND_SERVICE:
    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceUnbind&quot;);
    handleUnbindService((BindServiceData)msg.obj);
    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
    break;
case SERVICE_ARGS:
    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceStart&quot;);
    handleServiceArgs((ServiceArgsData)msg.obj);
    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
    break;
case STOP_SERVICE:
    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceStop&quot;);
    handleStopService((IBinder)msg.obj);
    maybeSnapshot();
    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
    break;
</code></pre><p>哈哈，真的中了，我们看到还有<code>BIND_SERVICE</code>和<code>UNBIND_SERVICE</code>，全部在这里，那么中间过程我们就可以猜想啦</p>
<pre><code>private void handleStopService(IBinder token) {
    Service s = mServices.remove(token);
    if (s != null) {
        try { 
            s.onDestroy();
            Context context = s.getBaseContext();
            if (context instanceof ContextImpl) {
                final String who = s.getClassName();
                ((ContextImpl) context).scheduleFinalCleanup(who, &quot;Service&quot;);
            }
            QueuedWork.waitToFinish();
            ActivityManagerNative.getDefault().serviceDoneExecuting(
                        token, SERVICE_DONE_EXECUTING_STOP, 0, 0); 
        } catch (Exception e) {
          ...
        }     
   }
} 
</code></pre><h1 id="大跃进—-—-绑定服务"><a href="#大跃进—-—-绑定服务" class="headerlink" title="大跃进— — 绑定服务"></a>大跃进— — 绑定服务</h1><p>现在我们直接来看下绑定服务是怎么回事</p>
<pre><code>@Override
public boolean bindService(Intent service, ServiceConnection conn,
        int flags) {
    return mBase.bindService(service, conn, flags);
}
</code></pre><p>老套路，我们继续看下ContextImpl的内容</p>
<pre><code>@Override
public boolean bindService(Intent service, ServiceConnection conn,
        int flags) {
    warnIfCallingFromSystemProcess();
    return bindServiceCommon(service, conn, flags, Process.myUserHandle());
}

private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags,
        UserHandle user) {
    IServiceConnection sd;
    if (conn == null) {
        throw new IllegalArgumentException(&quot;connection is null&quot;);
    }
    if (mPackageInfo != null) {
        sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(),
                mMainThread.getHandler(), flags);
    } else {
        throw new RuntimeException(&quot;Not supported in system context&quot;);
    }
    validateServiceIntent(service);
    try {
        IBinder token = getActivityToken();
        if (token == null &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == 0 &amp;&amp; mPackageInfo != null
                &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion
                &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) {
            flags |= BIND_WAIVE_PRIORITY;
        }
        service.prepareToLeaveProcess();
        int res = ActivityManagerNative.getDefault().bindService(
            mMainThread.getApplicationThread(), getActivityToken(), service,
            service.resolveTypeIfNeeded(getContentResolver()),
            sd, flags, getOpPackageName(), user.getIdentifier());
        if (res &lt; 0) {
            throw new SecurityException(
                    &quot;Not allowed to bind to service &quot; + service);
        }
        return res != 0;
    } catch (RemoteException e) {
        throw new RuntimeException(&quot;Failure from system&quot;, e);
    }
}
</code></pre><p>我们这里看到，最重要的一句还是上面第十行的位置，跑去调用AMS的<code>bindService</code>了。<br>另外这里有点要补充的内容就是，我们的这个绑定可能是跨进程的情况啊，所以我们看到上面，他把我们的<br>ServiceConnection被再次打包了一下，弄成了<code>IServiceConnection</code>，显然这个是一个<code>Binder</code>，和我们的广播类似啊，被打包成了<code>IIntentReceiver</code>，从而达到能够跨进程的效果。这个IServiceConnection也是在LoadedApk里面啊，保存着一个map，存储两者的关系，这里就不细细去看了，继续看我们的主线吧。</p>
<pre><code>public int bindService(IApplicationThread caller, IBinder token, Intent service,
        String resolvedType, IServiceConnection connection, int flags, String callingPackage,
        int userId) throws TransactionTooLargeException {
    enforceNotIsolatedCaller(&quot;bindService&quot;);

    // Refuse possible leaked file descriptors
    if (service != null &amp;&amp; service.hasFileDescriptors() == true) {
        throw new IllegalArgumentException(&quot;File descriptors passed in Intent&quot;);
    }

    if (callingPackage == null) {
        throw new IllegalArgumentException(&quot;callingPackage cannot be null&quot;);
    }

    synchronized(this) {
        return mServices.bindServiceLocked(caller, token, service,
                resolvedType, connection, flags, callingPackage, userId);
    }
}
</code></pre><p>我们看到结尾这里，继续调用了ActiveServices的bindServiceLocked(）。想说的是，这个ActivityService是负责给AMS打工，管理Service的启动，绑定，解绑和停止等工作的，终于想说这个AMS里面有点像组合模型的地方，把一些业务分割出去了。应该在分割出去点的，虽然很多都是判断和处理语句，太庞大了，整个AMS类</p>
<p>我们继续看下那个<code>bindServiceLock</code>，他和我们启动任务的时候类似，去调用了<code>bringUpServiceLocked</code>，调用完后就去<code>realStartServiceLocked</code>，后面流程类似，就不重复，唯一看完全部，不一样的地方当然是我们是绑定啊，要返回连接的啊！<br>在<code>RealStartServiceLock</code>里面，他继续去执行了函数结尾处的下面的函数</p>
<pre><code>requestServiceBindingsLocked(r, execInFg);
updateServiceClientActivitiesLocked(app, null, true);

private final boolean requestServiceBindingLocked(ServiceRecord r, IntentBindRecord i,
        boolean execInFg, boolean rebind) throws TransactionTooLargeException {

      ...

    if ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; 0) {

        bumpServiceExecutingLocked(r, execInFg, &quot;bind&quot;);
        r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);
        r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,
                r.app.repProcState);
        if (!rebind) {
            i.requested = true;
        }
        i.hasBound = true;
        i.doRebind = false;

    }
    ...
    return true;
}
</code></pre><p> 这样我们就看到他去调用多了ApplicationThread里面的scheduleBindService去绑定多服务！</p>
<pre><code>public final void scheduleBindService(IBinder token, Intent intent,
            boolean rebind, int processState) {
        updateProcessState(processState, false);
        BindServiceData s = new BindServiceData();
        s.token = token;
        s.intent = intent;
        s.rebind = rebind;

        if (DEBUG_SERVICE)
            Slog.v(TAG, &quot;scheduleBindService token=&quot; + token + &quot; intent=&quot; + intent + &quot; uid=&quot;
                    + Binder.getCallingUid() + &quot; pid=&quot; + Binder.getCallingPid());
        sendMessage(H.BIND_SERVICE, s);
    }
</code></pre><p>通过这里去绑定我们的服务</p>
<pre><code>private void handleBindService(BindServiceData data) {
    Service s = mServices.get(data.token);

    if (s != null) {            
         data.intent.setExtrasClassLoader(s.getClassLoader());
         data.intent.prepareToEnterProcess();
         try {
             if (!data.rebind) {
                 IBinder binder = s.onBind(data.intent);
                 ActivityManagerNative.getDefault().publishService(
                         data.token, data.intent, binder);
             } else {
                 s.onRebind(data.intent);
                 ActivityManagerNative.getDefault().serviceDoneExecuting(
                         data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);
             }
             ensureJitEnabled();
         } catch (RemoteException ex) {
         }         

    }
}
</code></pre><p>在这里我们看到，对于多次绑定，他调用了我们服务的onRebind函数！而对于第一次绑定，我们是调用了我们的服务的onBind函数，这和我们以前的开发经验也很对，不过好像缺少了跑到回调去的步骤啊，<br>看下去，嗯，应该是用AMS的<code>publishService</code>去做的，让我们探索下去吧！。</p>
<pre><code>public void publishService(IBinder token, Intent intent, IBinder service) {
    // Refuse possible leaked file descriptors
    if (intent != null &amp;&amp; intent.hasFileDescriptors() == true) {
        throw new IllegalArgumentException(&quot;File descriptors passed in Intent&quot;);
    }

    synchronized(this) {
        if (!(token instanceof ServiceRecord)) {
            throw new IllegalArgumentException(&quot;Invalid service token&quot;);
        }
        mServices.publishServiceLocked((ServiceRecord)token, intent, service);
    }
}
</code></pre><p>你看，我们的小助手mService又出现了，真的是管理Service的好助手啊</p>
<pre><code>void publishServiceLocked(ServiceRecord r, Intent intent, IBinder service) {
    final long origId = Binder.clearCallingIdentity(); 　　
        if (r != null) {
            Intent.FilterComparison filter
                    = new Intent.FilterComparison(intent);
            IntentBindRecord b = r.bindings.get(filter);
            if (b != null &amp;&amp; !b.received) {　
                for (int conni=r.connections.size()-1; conni&gt;=0; conni--) {
                    ArrayList&lt;ConnectionRecord&gt; clist = 
                    r.connections.valueAt(conni);
                    for (int i=0; i&lt;clist.size(); i++) {
                        ConnectionRecord c = clist.get(i);                            
                        ...                                                                                     
                        c.conn.connected(r.name, service);                             
                    }
                }
            }
          　serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), false);
       } 　
 }
</code></pre><p>　看到这里，需要解释下，还记得前面说，我们的ServiceConnection是被打包起来，弄成了<code>IServiceConnection</code>，才来达到跨进程的效果的，这里的<code>c.conn</code>就是原来那个iServiceConnection。<br>　很显然他的这个connected方法就是回调，像前面说的广播一样，再在里面去执行我们的方法的回调。</p>
<pre><code>private static class InnerConnection extends IServiceConnection.Stub {
        final WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;

        InnerConnection(LoadedApk.ServiceDispatcher sd) {
            mDispatcher = new WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);
        }

        public void connected(ComponentName name, IBinder service) throws RemoteException {
            LoadedApk.ServiceDispatcher sd = mDispatcher.get();
            if (sd != null) {
                sd.connected(name, service);
            }
        }
    }
</code></pre><p>这个我们看到跑到了<code>sd.connected();</code>不小心看成了连接sb.</p>
<pre><code>public void connected(ComponentName name, IBinder service) {
        if (mActivityThread != null) {
            mActivityThread.post(new RunConnection(name, service, 0));
        } else {
            doConnected(name, service);
        }
    }
</code></pre><p>好了，这里有看到一些熟悉的内容啦！！！<br>这个坑爹的mActivyThread！！实际上就是那个“H”先生！！，这里就不解释了！通过他来运行回主线程！既然是调用它的post方法去执行，继续看下那个RunConnection里面的内容吧</p>
<pre><code>public void run() {
  if (mCommand == 0) {
           doConnected(mName, mService);
       } else if (mCommand == 1) {
           doDeath(mName, mService);
       }
}
</code></pre><p>好了，我们去看下doConencted的内容把</p>
<pre><code>public void doConnected(ComponentName name, IBinder service) {
           ...
         if (service != null) {
            mConnection.onServiceConnected(name, service);
        }
}
</code></pre><p>到这里我们就回调到我们绑定的时候的的回调接口去。<br>好了，贴了这么多代码，终于进入尾声了，我们的整个绑定过程！
　
　 </p>
<hr>
<p>　
　</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>偷下懒，别的过程就先不写了。其余的过程基本最后也是跑回到那个H先生那里去执行下的，没什么大的问题的。<br>另外，说到Service，都会想到他的朋友IntentService，为何它可以执行一些耗时的操作呢？<br>这部分没写下来。</p>
<p>这样就剩下最后一个金刚没写他的故事啦，今晚抽空写下，就算对四大金刚有一个进一步的了解了！</p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag">#android</a>
          
            <a href="/tags/源码/" rel="tag">#源码</a>
          
            <a href="/tags/service/" rel="tag">#service</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/12/18/源码探索系列8---IntentService/" rel="prev">源码探索系列8---IntentService</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/17/源码探索系列5---关于Broadcast、LocalBroadcastManager 、EventBus的比较和源码解析/" rel="next">源码探索系列5---关于Broadcast、LocalBroadcastManager 、EventBus的比较和源码解析</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2015/12/18/源码探索系列7---四大金刚之Service/"
     data-title="源码探索系列7---四大金刚之Service"
     data-content=""
     data-url="http://yoursite.com/2015/12/18/源码探索系列7---四大金刚之Service/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>

 </div>

        
            <!-- 多说热评文章-->
            <p>热评文章</p>
            <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>
        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2015/12/18/源码探索系列7---四大金刚之Service/"
                   data-title="源码探索系列7---四大金刚之Service" data-url="http://yoursite.com/2015/12/18/源码探索系列7---四大金刚之Service/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table Of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/myAvatar.jpg" alt="SanjayF" itemprop="image"/>
          <p class="site-author-name" itemprop="name">SanjayF</p>
        </div>
        <p class="site-description motion-element" itemprop="description">SanjayF's  github  blog</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">118</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">127</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#起航—-开启服务"><span class="nav-number">1.</span> <span class="nav-text">起航—-开启服务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#前进—-—-停止服务"><span class="nav-number">2.</span> <span class="nav-text">前进— — 停止服务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#大跃进—-—-绑定服务"><span class="nav-number">3.</span> <span class="nav-text">大跃进— — 绑定服务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#后记"><span class="nav-number">4.</span> <span class="nav-text">后记</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SanjayF</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"sanjayf"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
